<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Chart Analyzer</title>
    <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/10503/10503979.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to the top */
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .container {
            max-width: 900px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            box-sizing: border-box;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .file-input-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            font-weight: 600;
            border: none;
            width: 100%;
            text-align: center;
        }
        .file-input-button:hover {
            background-color: #4338ca;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">
    <div class="container space-y-8">
        <h1 class="text-4xl font-bold text-center text-indigo-700 mb-6">Stock Chart Analyzer</h1>

        <div class="flex flex-col gap-8">
            <!-- Image Upload Section -->
            <div class="w-full bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Upload Chart Screenshot</h2>
                
                <div class="mb-4">
                    <label for="entryPrice" class="block text-gray-700 text-sm font-bold mb-2">
                        Entry Price (Optional):
                    </label>
                    <input type="number" id="entryPrice" placeholder="e.g., 150.75" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-indigo-500">
                </div>

                <div class="file-input-wrapper mb-4">
                    <input type="file" id="chartUpload" accept="image/png, image/jpeg, image/webp">
                    <label for="chartUpload" class="file-input-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v8" />
                        </svg>
                        <span id="uploadText">Choose Image</span>
                    </label>
                </div>
                <div class="mb-4 text-sm text-gray-500">
                    Supported formats: PNG, JPEG, WEBP. Max size: 7MB.
                </div>
                <div id="imagePreviewContainer" class="mt-4 border border-gray-300 rounded-md p-2 flex justify-center items-center bg-gray-50 min-h-[200px] overflow-hidden">
                    <img id="chartPreview" src="https://placehold.co/400x300/e0e0e0/555555?text=Chart+Preview" alt="Chart Preview" class="max-w-full h-auto rounded-md object-contain">
                </div>
                <button id="analyzeBtn" class="mt-6 w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition ease-in-out duration-150">
                    Analyze Chart
                </button>
            </div>

            <!-- Analysis Result Section -->
            <div class="w-full bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Analysis Result</h2>
                <div id="loadingIndicator" class="loader my-8"></div>
                <div id="analysisResult" class="bg-gray-50 p-4 rounded-md border border-gray-200 text-gray-700 leading-relaxed">
                    <p class="text-gray-500">Upload a stock chart and click "Analyze Chart" to get insights from an AI swing trader.</p>
                </div>
                 <!-- Custom Message Box -->
                <div id="messageBox" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                        <h3 id="messageBoxTitle" class="text-lg font-bold mb-2 text-gray-900"></h3>
                        <p id="messageBoxContent" class="text-gray-700 mb-4"></p>
                        <button id="messageBoxCloseBtn" class="w-full py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chartUpload = document.getElementById('chartUpload');
        const chartPreview = document.getElementById('chartPreview');
        const uploadText = document.getElementById('uploadText');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analysisResult = document.getElementById('analysisResult');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');
        const entryPriceInput = document.getElementById('entryPrice');

        let base64Image = ''; // To store the base64 string of the uploaded image

        // Function to show custom message box
        function showMessageBox(title, message) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBox.classList.remove('hidden');
        }

        // Close button for message box
        messageBoxCloseBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // Function to format the raw text response into HTML
        function formatAnalysisResult(rawText) {
            let htmlContent = '';
            
            const lines = rawText.split('\n');
            let inUnorderedList = false;
            let inOrderedList = false;

            lines.forEach(line => {
                let trimmedLine = line.trim();

                // Convert bold markdown to HTML strong tags
                trimmedLine = trimmedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Convert italics markdown to HTML em tags
                trimmedLine = trimmedLine.replace(/\*(.*?)\*/g, '<em>$1</em>');
                trimmedLine = trimmedLine.replace(/_(.*?)_/g, '<em>$1</em>');


                if (trimmedLine.startsWith('### ')) {
                    // Close any open lists before a heading
                    if (inUnorderedList) { htmlContent += '</ul>'; inUnorderedList = false; }
                    if (inOrderedList) { htmlContent += '</ol>'; inOrderedList = false; }
                    htmlContent += `<h3 class="text-xl font-semibold mt-4 mb-2 text-indigo-800">${trimmedLine.substring(4).trim()}</h3>`;
                } else if (trimmedLine.match(/^\d+\.\s/)) { // Ordered list item (e.g., "1. ")
                    if (inUnorderedList) { htmlContent += '</ul>'; inUnorderedList = false; }
                    if (!inOrderedList) { htmlContent += '<ol class="list-decimal list-inside ml-4 mb-2">'; inOrderedList = true; }
                    htmlContent += `<li class="mb-1">${trimmedLine}</li>`;
                } else if (trimmedLine.startsWith('* ') || trimmedLine.startsWith('- ')) { // Unordered list item
                    if (inOrderedList) { htmlContent += '</ol>'; inOrderedList = false; }
                    if (!inUnorderedList) { htmlContent += '<ul class="list-disc list-inside ml-4 mb-2">'; inUnorderedList = true; }
                    htmlContent += `<li class="mb-1">${trimmedLine.substring(2).trim()}</li>`;
                } else if (trimmedLine === '') {
                    // Close lists if there's an empty line after them
                    if (inUnorderedList) { htmlContent += '</ul>'; inUnorderedList = false; }
                    if (inOrderedList) { htmlContent += '</ol>'; inOrderedList = false; }
                    htmlContent += '<p class="mb-2">&nbsp;</p>'; // Add a non-breaking space for line breaks
                } else {
                    // Close any open lists before a regular paragraph
                    if (inUnorderedList) { htmlContent += '</ul>'; inUnorderedList = false; }
                    if (inOrderedList) { htmlContent += '</ol>'; inOrderedList = false; }
                    htmlContent += `<p class="mb-2">${trimmedLine}</p>`;
                }
            });

            // Close any remaining open lists at the end
            if (inUnorderedList) { htmlContent += '</ul>'; }
            if (inOrderedList) { htmlContent += '</ol>'; }

            // Add emojis based on keywords (simple example)
            htmlContent = htmlContent.replace(/uptrend/g, 'uptrend üìà');
            htmlContent = htmlContent.replace(/downtrend/g, 'downtrend üìâ');
            htmlContent = htmlContent.replace(/strong/g, 'strong üí™'); // Applies to "momentum is strong" or other strong instances
            htmlContent = htmlContent.replace(/Golden Cross/g, 'Golden Cross ‚ú®');
            htmlContent = htmlContent.replace(/decision/g, 'decision üí°');
            htmlContent = htmlContent.replace(/support/g, 'support üõ°Ô∏è');
            htmlContent = htmlContent.replace(/resistance/g, 'resistance üß±');
            htmlContent = htmlContent.replace(/buy/g, 'buy üü¢');
            htmlContent = htmlContent.replace(/sell/g, 'sell üî¥');
            htmlContent = htmlContent.replace(/Profit/g, 'Profit üí∞');
            htmlContent = htmlContent.replace(/Loss/g, 'Loss üí∏');
            htmlContent = htmlContent.replace(/risk/g, 'risk ‚ö†Ô∏è');


            return htmlContent;
        }

        chartUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (max 7MB for Gemini API)
                if (file.size > 7 * 1024 * 1024) {
                    showMessageBox('File Too Large', 'Please upload an image smaller than 7MB.');
                    chartUpload.value = ''; // Clear the input
                    chartPreview.src = "https://placehold.co/400x300/e0e0e0/555555?text=Chart+Preview";
                    uploadText.textContent = "Choose Image";
                    base64Image = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    chartPreview.src = e.target.result;
                    // Extract base64 part for the API call
                    base64Image = e.target.result.split(',')[1];
                };
                reader.readAsDataURL(file);
                uploadText.textContent = file.name;
            } else {
                chartPreview.src = "https://placehold.co/400x300/e0e0e0/555555?text=Chart+Preview";
                uploadText.textContent = "Choose Image";
                base64Image = '';
            }
        });

        analyzeBtn.addEventListener('click', async () => {
            if (!base64Image) {
                showMessageBox('No Image Uploaded', 'Please upload a stock chart screenshot before analyzing.');
                return;
            }

            analysisResult.innerHTML = ''; // Clear previous results
            loadingIndicator.style.display = 'block'; // Show loader

            const entryPrice = entryPriceInput.value;
            let prompt = `‡¶è‡¶ï‡¶ú‡¶® ‡¶Ö‡¶§‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶¶‡¶ï‡ßç‡¶∑ ‡¶∏‡ßÅ‡¶á‡¶Ç ‡¶ü‡ßç‡¶∞‡ßá‡¶°‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá, ‡¶è‡¶á ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶ï‡ßÄ ‡¶Ö‡¶∞‡ßç‡¶• ‡¶¨‡¶π‡¶® ‡¶ï‡¶∞‡ßá ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡ßÄ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™ ‡¶®‡ßá‡¶¨‡ßá‡¶® ‡¶§‡¶æ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ `;

            if (entryPrice && !isNaN(parseFloat(entryPrice))) {
                prompt += `‡¶Ø‡¶¶‡¶ø ‡¶ü‡ßç‡¶∞‡ßá‡¶°‡¶æ‡¶∞‡¶ü‡¶ø **${parseFloat(entryPrice).toFixed(2)}** ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶∏‡ßá ‡¶ü‡ßç‡¶∞‡ßá‡¶°‡ßá ‡¶•‡ßá‡¶ï‡ßá ‡¶•‡¶æ‡¶ï‡ßá‡¶®, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶§‡¶æ‡¶∞ ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶æ ‡¶â‡¶ö‡¶ø‡¶§ ‡¶∏‡ßá‡¶á ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá‡¶ì ‡¶∏‡ßÅ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶¶‡¶ø‡¶®, ‡¶Ø‡¶æ‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá Take Profit ‡¶è‡¶¨‡¶Ç Stop Loss ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶Ö‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶≠‡ßÅ‡¶ï‡ßç‡¶§ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§ `;
            }

            prompt += `‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡¶°‡¶æ‡¶â‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶Ø‡¶º ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶π‡ßá‡¶°‡¶ø‡¶Ç, ‡¶¨‡ßÅ‡¶≤‡ßá‡¶ü ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü, ‡¶¨‡ßã‡¶≤‡ßç‡¶° ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü)‡•§ ‡¶§‡¶¨‡ßá 'MA', 'RSI', 'Support', 'Resistance', 'Candlestick', 'Volume', 'Breakout', 'Retest', 'Golden Cross', 'Death Cross', 'Uptrend', 'Downtrend', 'Consolidation', 'Stop Loss', 'Take Profit', 'Entry', 'Exit' ‡¶è‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶ü‡ßç‡¶∞‡ßá‡¶°‡¶ø‡¶Ç ‡¶∂‡¶¨‡ßç‡¶¶‡¶ó‡ßÅ‡¶≤‡ßã ‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø‡¶§‡ßá‡¶á ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®‡•§ MA 10 ‡¶¨‡ßá‡¶ó‡ßÅ‡¶®‡¶ø, MA 20 ‡¶∏‡¶¨‡ßÅ‡¶ú, MA 50 ‡¶ï‡¶æ‡¶≤‡ßã, MA 200 ‡¶π‡¶≤‡ßÅ‡¶¶‡•§ ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶∞‡ßá‡¶°‡¶æ‡¶∞‡¶ï‡ßá ‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§ ‡¶®‡¶ø‡¶§‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßÅ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ ‡¶â‡¶ö‡¶ø‡¶§‡•§`;


            let chatHistory = [];
            chatHistory.push({
                role: "user",
                parts: [{
                    text: prompt
                }, {
                    inlineData: {
                        mimeType: "image/png", // Assuming PNG, but can be adjusted based on `file.type`
                        data: base64Image
                    }
                }]
            });

            const payload = {
                contents: chatHistory
            };

            // IMPORTANT: For production deployments on GitHub Pages,
            // NEVER expose your API key directly in client-side code.
            // Use a secure backend to proxy your API calls.
            // For local testing/personal use, you can replace "YOUR_GEMINI_API_KEY"
            // with your actual Gemini API Key from Google AI Studio.
            const apiKey = "AIzaSyChsJtQKCt8pJUCTjIe_-e0t777uWzXY7A"; // <<-- REPLACE THIS WITH YOUR ACTUAL API KEY FOR TESTING
            // For Canvas environment, this variable is automatically populated.
            // If running on GitHub Pages, you MUST provide your key here or use a backend.

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let retryCount = 0;
            const maxRetries = 5;
            const initialDelay = 1000; // 1 second

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) { // Too Many Requests
                            const delay = initialDelay * Math.pow(2, retryCount);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retryCount++;
                            continue; // Retry the request
                        } else {
                            throw new Error(`API error: ${response.status} ${response.statusText}`);
                        }
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        let rawText = result.candidates[0].content.parts[0].text;
                        // Format the raw text with HTML tags and emojis
                        analysisResult.innerHTML = formatAnalysisResult(rawText);
                    } else {
                        analysisResult.innerHTML = `<p class="text-red-600">Could not get a valid analysis from the AI. Please try again or with a different image.</p>`;
                        console.error("Unexpected API response structure:", result);
                    }
                    break; // Exit loop on success
                } catch (error) {
                    analysisResult.innerHTML = `<p class="text-red-600">Error analyzing chart: ${error.message}</p>`;
                    console.error("Error during API call:", error);
                    break; // Exit loop on unrecoverable error
                } finally {
                    loadingIndicator.style.display = 'none'; // Hide loader
                }
            }

            if (retryCount === maxRetries) {
                analysisResult.innerHTML = `<p class="text-red-600">Failed to analyze chart after multiple retries. Please check your network connection or try again later.</p>`;
            }
        });
        console.log("Stock Chart Analyzer script loaded successfully.");
    </script>
</body>
</html>
