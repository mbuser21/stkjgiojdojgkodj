<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Chart Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to the top */
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .container {
            max-width: 900px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            box-sizing: border-box;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .file-input-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            font-weight: 600;
            border: none;
            width: 100%;
            text-align: center;
        }
        .file-input-button:hover {
            background-color: #4338ca;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">
    <div class="container space-y-8">
        <h1 class="text-4xl font-bold text-center text-indigo-700 mb-6">Stock Chart Analyzer</h1>

        <div class="flex flex-col gap-8">
            <!-- Image Input Section -->
            <div class="w-full bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Provide Chart Image</h2>
                
                <div class="mb-4">
                    <label for="entryPrice" class="block text-gray-700 text-sm font-bold mb-2">
                        Entry Price (Optional):
                    </label>
                    <input type="number" id="entryPrice" placeholder="e.g., 150.75" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-indigo-500">
                </div>

                <div class="mb-4">
                    <label for="imageUrl" class="block text-gray-700 text-sm font-bold mb-2">
                        Image URL:
                    </label>
                    <input type="text" id="imageUrl" placeholder="e.g., https://s3.tradingview.com/snapshots/k/kViaEhps.png" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-indigo-500">
                </div>

                <button id="loadImageBtn" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition ease-in-out duration-150 mb-4">
                    Load Image from URL
                </button>
                
                <div class="mb-4 text-sm text-gray-500">
                    Supported formats: PNG, JPEG, WEBP. Max size: 7MB.
                </div>
                <div id="imagePreviewContainer" class="mt-4 border border-gray-300 rounded-md p-2 flex justify-center items-center bg-gray-50 min-h-[200px] overflow-hidden">
                    <img id="chartPreview" src="https://placehold.co/400x300/e0e0e0/555555?text=Chart+Preview" alt="Chart Preview" class="max-w-full h-auto rounded-md object-contain">
                </div>
                <button id="analyzeBtn" class="mt-6 w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition ease-in-out duration-150">
                    Analyze Chart
                </button>
            </div>

            <!-- Analysis Result Section -->
            <div class="w-full bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Analysis Result</h2>
                <div id="loadingIndicator" class="loader my-8"></div>
                <div id="analysisResult" class="bg-gray-50 p-4 rounded-md border border-gray-200 text-gray-700 leading-relaxed">
                    <p class="text-gray-500">Upload a stock chart or provide its URL and click "Analyze Chart" to get insights from an AI swing trader.</p>
                </div>
                 <!-- Custom Message Box -->
                <div id="messageBox" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                        <h3 id="messageBoxTitle" class="text-lg font-bold mb-2 text-gray-900"></h3>
                        <p id="messageBoxContent" class="text-gray-700 mb-4"></p>
                        <button id="messageBoxCloseBtn" class="w-full py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const imageUrlInput = document.getElementById('imageUrl');
        const loadImageBtn = document.getElementById('loadImageBtn');
        const chartPreview = document.getElementById('chartPreview');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analysisResult = document.getElementById('analysisResult');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');
        const entryPriceInput = document.getElementById('entryPrice');

        let base64Image = ''; // To store the base64 string of the uploaded image
        let imageMimeType = ''; // To store the MIME type of the loaded image

        // Function to show custom message box
        function showMessageBox(title, message) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBox.classList.remove('hidden');
        }

        // Close button for message box
        messageBoxCloseBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // Function to format the raw text response into HTML
        function formatAnalysisResult(rawText) {
            let htmlContent = '';
            
            const lines = rawText.split('\n');
            let inUnorderedList = false;
            let inOrderedList = false;

            lines.forEach(line => {
                let trimmedLine = line.trim();

                // Convert bold markdown to HTML strong tags
                trimmedLine = trimmedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Convert italics markdown to HTML em tags
                trimmedLine = trimmedLine.replace(/\*(.*?)\*/g, '<em>$1</em>');
                trimmedLine = trimmedLine.replace(/_(.*?)_/g, '<em>$1</em>');


                if (trimmedLine.startsWith('### ')) {
                    // Close any open lists before a heading
                    if (inUnorderedList) { htmlContent += '</ul>'; inUnorderedList = false; }
                    if (inOrderedList) { htmlContent += '</ol>'; inOrderedList = false; }
                    htmlContent += `<h3 class="text-xl font-semibold mt-4 mb-2 text-indigo-800">${trimmedLine.substring(4).trim()}</h3>`;
                } else if (trimmedLine.match(/^\d+\.\s/)) { // Ordered list item (e.g., "1. ")
                    if (inUnorderedList) { htmlContent += '</ul>'; inUnorderedList = false; }
                    if (!inOrderedList) { htmlContent += '<ol class="list-decimal list-inside ml-4 mb-2">'; inOrderedList = true; }
                    htmlContent += `<li class="mb-1">${trimmedLine}</li>`;
                } else if (trimmedLine.startsWith('* ') || trimmedLine.startsWith('- ')) { // Unordered list item
                    if (inOrderedList) { htmlContent += '</ol>'; inOrderedList = false; }
                    if (!inUnorderedList) { htmlContent += '<ul class="list-disc list-inside ml-4 mb-2">'; inUnorderedList = true; }
                    htmlContent += `<li class="mb-1">${trimmedLine.substring(2).trim()}</li>`;
                } else if (trimmedLine === '') {
                    // Close lists if there's an empty line after them
                    if (inUnorderedList) { htmlContent += '</ul>'; inUnorderedList = false; }
                    if (inOrderedList) { htmlContent += '</ol>'; inOrderedList = false; }
                    htmlContent += '<p class="mb-2">&nbsp;</p>'; // Add a non-breaking space for line breaks
                } else {
                    // Close any open lists before a regular paragraph
                    if (inUnorderedList) { htmlContent += '</ul>'; inUnorderedList = false; }
                    if (inOrderedList) { htmlContent += '</ol>'; inOrderedList = false; }
                    htmlContent += `<p class="mb-2">${trimmedLine}</p>`;
                }
            });

            // Close any remaining open lists at the end
            if (inUnorderedList) { htmlContent += '</ul>'; }
            if (inOrderedList) { htmlContent += '</ol>'; }

            // Add emojis based on keywords (simple example)
            htmlContent = htmlContent.replace(/uptrend/g, 'uptrend 📈');
            htmlContent = htmlContent.replace(/downtrend/g, 'downtrend 📉');
            htmlContent = htmlContent.replace(/strong/g, 'strong 💪'); // Applies to "momentum is strong" or other strong instances
            htmlContent = htmlContent.replace(/Golden Cross/g, 'Golden Cross ✨');
            htmlContent = htmlContent.replace(/decision/g, 'decision 💡');
            htmlContent = htmlContent.replace(/support/g, 'support 🛡️');
            htmlContent = htmlContent.replace(/resistance/g, 'resistance 🧱');
            htmlContent = htmlContent.replace(/buy/g, 'buy 🟢');
            htmlContent = htmlContent.replace(/sell/g, 'sell 🔴');
            htmlContent = htmlContent.replace(/Profit/g, 'Profit 💰');
            htmlContent = htmlContent.replace(/Loss/g, 'Loss 💸');
            htmlContent = htmlContent.replace(/risk/g, 'risk ⚠️');


            return htmlContent;
        }

        // Function to load image from URL and convert to Base64
        loadImageBtn.addEventListener('click', async () => {
            const imageUrl = imageUrlInput.value.trim();
            if (!imageUrl) {
                showMessageBox('No URL Provided', 'Please enter an image URL.');
                return;
            }

            // Clear previous preview and base64 data
            chartPreview.src = "https://placehold.co/400x300/e0e0e0/555555?text=Loading...";
            base64Image = '';
            imageMimeType = '';
            
            try {
                const response = await fetch(imageUrl);
                if (!response.ok) {
                    throw new Error(`Failed to load image from URL: ${response.statusText}`);
                }

                const blob = await response.blob();
                imageMimeType = blob.type; // Get actual MIME type

                // Check if the MIME type is a supported image format
                if (!['image/png', 'image/jpeg', 'image/webp'].includes(imageMimeType)) {
                    showMessageBox('Unsupported Image Type', `The URL provided is not a supported image type (${imageMimeType}). Please use PNG, JPEG, or WEBP.`);
                    chartPreview.src = "https://placehold.co/400x300/e0e0e0/555555?text=Error+Loading";
                    return;
                }

                // Check file size (max 7MB for Gemini API)
                if (blob.size > 7 * 1024 * 1024) {
                    showMessageBox('Image Too Large', 'The image from the URL is larger than 7MB. Please use a smaller image.');
                    chartPreview.src = "https://placehold.co/400x300/e0e0e0/555555?text=Too+Large";
                    return;
                }

                const reader = new FileReader();
                reader.onloadend = function() {
                    chartPreview.src = URL.createObjectURL(blob); // Use blob URL for preview for better performance
                    base64Image = reader.result.split(',')[1]; // Get only the base64 part
                };
                reader.readAsDataURL(blob);

            } catch (error) {
                showMessageBox('Image Load Error', `Could not load image: ${error.message}. Please check the URL.`);
                console.error("Image loading error:", error);
                chartPreview.src = "https://placehold.co/400x300/e0e0e0/555555?text=Error+Loading";
            }
        });


        analyzeBtn.addEventListener('click', async () => {
            if (!base64Image) {
                showMessageBox('No Image Loaded', 'Please load a stock chart image from a URL before analyzing.');
                return;
            }

            analysisResult.innerHTML = ''; // Clear previous results
            loadingIndicator.style.display = 'block'; // Show loader

            const entryPrice = entryPriceInput.value;
            let prompt = `একজন অত্যন্ত দক্ষ সুইং ট্রেডার হিসেবে, এই দিনের চার্টটি আপনার কাছে কী অর্থ বহন করে এবং আপনি কী পদক্ষেপ নেবেন তা বিশ্লেষণ করুন। `;

            if (entryPrice && !isNaN(parseFloat(entryPrice))) {
                prompt += `যদি ট্রেডারটি **${parseFloat(entryPrice).toFixed(2)}** এন্ট্রি প্রাইসে ট্রেডে থেকে থাকেন, তাহলে তার কী করা উচিত সেই বিষয়েও সুনির্দিষ্ট পরামর্শ দিন, যার মধ্যে Take Profit এবং Stop Loss লেভেল অন্তর্ভুক্ত থাকবে। `;
            }

            prompt += `আপনার প্রতিক্রিয়া স্পষ্টভাবে মার্কডাউন ব্যবহার করে বাংলায় লিখুন (যেমন: হেডিং, বুলেট পয়েন্ট, বোল্ড টেক্সট)। তবে 'MA', 'RSI', 'Support', 'Resistance', 'Candlestick', 'Volume', 'Breakout', 'Retest', 'Golden Cross', 'Death Cross', 'Uptrend', 'Downtrend', 'Consolidation', 'Stop Loss', 'Take Profit', 'Entry', 'Exit' এর মতো ট্রেডিং শব্দগুলো ইংরেজিতেই রাখুন। MA 10 বেগুনি, MA 20 সবুজ, MA 50 কালো, MA 200 হলুদ। এটি একজন নতুন ট্রেডারকে সিদ্ধান্ত নিতে সাহায্য করার জন্য সংক্ষিপ্ত এবং সুস্পষ্ট হওয়া উচিত।`;


            let chatHistory = [];
            chatHistory.push({
                role: "user",
                parts: [{
                    text: prompt
                }, {
                    inlineData: {
                        mimeType: imageMimeType || "image/png", // Use detected MIME type, fallback to png
                        data: base64Image
                    }
                }]
            });

            const payload = {
                contents: chatHistory
            };

            // IMPORTANT: For production deployments on GitHub Pages,
            // NEVER expose your API key directly in client-side code.
            // Use a secure backend to proxy your API calls.
            // For local testing/personal use, you can replace "YOUR_GEMINI_API_KEY"
            // with your actual Gemini API Key from Google AI Studio.
            const apiKey = "AIzaSyChsJtQKCt8pJUCTjIe_-e0t777uWzXY7A"; // <<-- REPLACE THIS WITH YOUR ACTUAL API KEY FOR TESTING
            // For Canvas environment, this variable is automatically populated.
            // If running on GitHub Pages, you MUST provide your key here or use a backend.

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let retryCount = 0;
            const maxRetries = 5;
            const initialDelay = 1000; // 1 second

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) { // Too Many Requests
                            const delay = initialDelay * Math.pow(2, retryCount);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retryCount++;
                            continue; // Retry the request
                        } else {
                            throw new Error(`API error: ${response.status} ${response.statusText}`);
                        }
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        let rawText = result.candidates[0].content.parts[0].text;
                        // Format the raw text with HTML tags and emojis
                        analysisResult.innerHTML = formatAnalysisResult(rawText);
                    } else {
                        analysisResult.innerHTML = `<p class="text-red-600">AI থেকে কোনো সঠিক বিশ্লেষণ পাওয়া যায়নি। অনুগ্রহ করে আবার চেষ্টা করুন অথবা অন্য একটি ছবি ব্যবহার করুন।</p>`;
                        console.error("Unexpected API response structure:", result);
                    }
                    break; // Exit loop on success
                } catch (error) {
                    analysisResult.innerHTML = `<p class="text-red-600">চার্ট বিশ্লেষণ করতে ত্রুটি: ${error.message}</p>`;
                    console.error("Error during API call:", error);
                    break; // Exit loop on unrecoverable error
                } finally {
                    loadingIndicator.style.display = 'none'; // Hide loader
                }
            }

            if (retryCount === maxRetries) {
                analysisResult.innerHTML = `<p class="text-red-600">কয়েকবার চেষ্টার পরও চার্ট বিশ্লেষণ করা সম্ভব হয়নি। অনুগ্রহ করে আপনার নেটওয়ার্ক সংযোগ পরীক্ষা করুন অথবা পরে আবার চেষ্টা করুন।</p>`;
            }
        });
        console.log("Stock Chart Analyzer script loaded successfully.");
    </script>
</body>
</html>
